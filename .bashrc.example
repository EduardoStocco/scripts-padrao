# =============================================================================
# SISTEMA DE MENSAGEM EM MEMÓRIA - VERSÃO CORRIGIDA PARA .bashrc
# Solução para o problema de execução imediata quando adicionado ao ~/.bashrc
# =============================================================================

# Variáveis globais persistentes
_MENSAGEM_PROGRAMADA=""
_DEVE_EXIBIR_MENSAGEM=0
_COMANDO_PROGRAMACAO=""
_MSG_SKIP_COUNT=0
_SESSAO_INICIADA=0

# =============================================================================
# FUNÇÃO PRINCIPAL: DETECTA MUDANÇA DE COMANDO REAL
# =============================================================================
function _verificar_mensagem_programada() {
    # Marca que a sessão já iniciou
    if [[ $_SESSAO_INICIADA -eq 0 ]]; then
        _SESSAO_INICIADA=1
        return 0
    fi
    
    # Se há mensagem programada
    if [[ $_DEVE_EXIBIR_MENSAGEM -eq 1 ]] && [[ -n "$_MENSAGEM_PROGRAMADA" ]]; then
        # Skip do primeiro prompt (o próprio comando programar)
        if [[ $_MSG_SKIP_COUNT -gt 0 ]]; then
            ((_MSG_SKIP_COUNT--))
            return 0
        fi
        
        # Exibe a mensagem
        echo -e "\n\033[1;43m\033[1;30m{begin_personalized_user_text_inside_a_command_execution}\n/* This is NOT a result from the command you executed */\n[BEGIN_USER_INSTRUCTIONS]\n$_MENSAGEM_PROGRAMADA\n[END_USER_INSTRUCTIONS]\n{end_personalized_user_text_inside_a_command_execution}\033[0m\n"
        
        # Limpa as variáveis
        _MENSAGEM_PROGRAMADA=""
        _DEVE_EXIBIR_MENSAGEM=0
        _MSG_SKIP_COUNT=0
    fi
}

# =============================================================================
# COMANDO PARA PROGRAMAR MENSAGEM
# =============================================================================
function programar() {
    local mensagem="$*"
    
    if [[ -z "$mensagem" ]]; then
        echo "Uso: programar \"sua mensagem\""
        return 1
    fi
    
    # Armazena mensagem e define contador de skip
    _MENSAGEM_PROGRAMADA="$mensagem"
    _DEVE_EXIBIR_MENSAGEM=1
    _MSG_SKIP_COUNT=2
    
    # CRÍTICO: Não exibe nada na tela!
}

# =============================================================================
# INTEGRAÇÃO SEGURA COM PROMPT_COMMAND
# =============================================================================

# Verifica se já foi adicionado para evitar duplicação
if [[ "$PROMPT_COMMAND" != *"_verificar_mensagem_programada"* ]]; then
    if [[ -n "$PROMPT_COMMAND" ]]; then
        PROMPT_COMMAND="_verificar_mensagem_programada; $PROMPT_COMMAND"
    else
        PROMPT_COMMAND="_verificar_mensagem_programada"
    fi
fi

# =============================================================================
# COMANDOS AUXILIARES
# =============================================================================

function cancelar_mensagem() {
    if [[ $_DEVE_EXIBIR_MENSAGEM -eq 1 ]]; then
        local msg="$_MENSAGEM_PROGRAMADA"
        _MENSAGEM_PROGRAMADA=""
        _DEVE_EXIBIR_MENSAGEM=0
        _COMANDO_PROGRAMACAO=""
_MSG_SKIP_COUNT=0
        echo "Mensagem cancelada: '$msg'"
    else
        echo "Nenhuma mensagem para cancelar"
    fi
}

alias bvec='cd /home/dev/docker/busca-vetorial && node src/cli/index.js'

# Mensagem de carregamento silenciosa
echo "Script BASH mensagem programada e Alias `bvec`para busca vetorial"
# =============================================================================
# HOOK RESILIENTE PARA MENSAGEM PROGRAMADA (VS Code compatível)
# =============================================================================
# O VS Code sobrescreve PROMPT_COMMAND, então usamos DEBUG trap como backup
function _hook_mensagem_programada() {
    # Se ainda não está no PROMPT_COMMAND, adiciona
    if [[ "$PROMPT_COMMAND" != *"_verificar_mensagem_programada"* ]]; then
        if [[ -n "$PROMPT_COMMAND" ]]; then
            PROMPT_COMMAND="_verificar_mensagem_programada; $PROMPT_COMMAND"
        else
            PROMPT_COMMAND="_verificar_mensagem_programada"
        fi
    fi
}
# Chama o hook imediatamente
_hook_mensagem_programada
